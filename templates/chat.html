{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card glow">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4 class="mb-0">AI Interview Session</h4>
                <div>
                    <span class="badge" id="questionCounter">Question: 0/5</span>
                    <span class="badge" id="scoreCounter">Score: 0/50</span>
                </div>
            </div>
            <div class="card-body">
                <div class="chat-container" id="chatContainer">
                    <div class="message ai-message">
                        <strong>AI Interviewer:</strong> Welcome! Please tell me about yourself. You can type your response or use voice recording.
                    </div>
                </div>
                
                <div class="mt-4">
                    <div class="input-group">
                        <input type="text" class="form-control" id="messageInput" placeholder="Type your response here..." onkeypress="handleKeyPress(event)">
                        <button class="record-btn" id="recordBtn" onclick="toggleRecording()" title="Voice Record">
                            ðŸŽ¤
                        </button>
                        <button class="btn btn-success" onclick="sendMessage()" style="border-radius: 0 25px 25px 0;">Send</button>
                    </div>
                    <div class="mt-2 text-center">
                        <small id="recordStatus">Type or click microphone to record</small>
                    </div>
                </div>
                
                <div class="mt-3" id="transcriptionArea" style="display: none;">
                    <div class="alert">
                        <strong>Voice transcription:</strong> <span id="transcriptionText"></span>
                    </div>
                    <button class="btn btn-primary" onclick="useTranscription()">Use This</button>
                    <button class="btn btn-secondary" onclick="recordAgain()">Record Again</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let mediaRecorder;
let audioChunks = [];
let isRecording = false;
let currentQuestion = "";
let questionNumber = 0;
let totalScore = 0;
let isIntroduction = true;

function handleKeyPress(event) {
    if (event.key === 'Enter') {
        sendMessage();
    }
}

function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    
    if (message) {
        addMessage(message, 'user');
        input.value = '';
        
        if (isIntroduction) {
            evaluateIntroduction(message);
        } else {
            evaluateAnswer(message);
        }
    }
}

async function toggleRecording() {
    if (!isRecording) {
        await startRecording();
    } else {
        stopRecording();
    }
}

async function startRecording() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        
        mediaRecorder.ondataavailable = event => {
            audioChunks.push(event.data);
        };
        
        mediaRecorder.onstop = async () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
            await processAudio(audioBlob);
        };
        
        mediaRecorder.start();
        isRecording = true;
        
        document.getElementById('recordBtn').classList.add('recording');
        document.getElementById('recordStatus').textContent = 'Recording... Click to stop';
    } catch (error) {
        alert('Error accessing microphone: ' + error.message);
    }
}

function stopRecording() {
    if (mediaRecorder && isRecording) {
        mediaRecorder.stop();
        mediaRecorder.stream.getTracks().forEach(track => track.stop());
        isRecording = false;
        
        document.getElementById('recordBtn').classList.remove('recording');
        document.getElementById('recordStatus').textContent = 'Processing...';
    }
}

async function processAudio(audioBlob) {
    const formData = new FormData();
    formData.append('audio', audioBlob, 'audio.wav');
    
    try {
        const response = await fetch('/process_audio', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.transcription) {
            document.getElementById('transcriptionText').textContent = data.transcription;
            document.getElementById('transcriptionArea').style.display = 'block';
            document.getElementById('recordStatus').textContent = 'Type or click microphone to record';
        } else {
            alert('Error processing audio: ' + data.error);
            document.getElementById('recordStatus').textContent = 'Type or click microphone to record';
        }
    } catch (error) {
        alert('Error: ' + error.message);
        document.getElementById('recordStatus').textContent = 'Type or click microphone to record';
    }
}

function useTranscription() {
    const transcription = document.getElementById('transcriptionText').textContent;
    document.getElementById('messageInput').value = transcription;
    document.getElementById('transcriptionArea').style.display = 'none';
}

function recordAgain() {
    document.getElementById('transcriptionArea').style.display = 'none';
}

function addMessage(text, sender) {
    const chatContainer = document.getElementById('chatContainer');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender === 'user' ? 'user-message' : 'ai-message'}`;
    messageDiv.innerHTML = `<strong>${sender === 'user' ? 'You' : 'AI Interviewer'}:</strong> ${text}`;
    chatContainer.appendChild(messageDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

async function evaluateIntroduction(introText) {
    try {
        const response = await fetch('/evaluate_intro', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ intro_text: introText })
        });
        
        const data = await response.json();
        
        addMessage(data.feedback, 'ai');
        
        isIntroduction = false;
        questionNumber = 1;
        currentQuestion = data.next_question;
        
        setTimeout(() => {
            addMessage(`Question ${questionNumber}/5 (${data.difficulty}): ${data.next_question}`, 'ai');
            updateCounters();
        }, 1000);
        
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function evaluateAnswer(answerText) {
    try {
        const response = await fetch('/evaluate_answer', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                question: currentQuestion,
                answer: answerText,
                question_number: questionNumber,
                difficulty: getCurrentDifficulty()
            })
        });
        
        const data = await response.json();
        
        addMessage(data.evaluation, 'ai');
        
        totalScore += data.score;
        updateCounters();
        
        if (data.finished) {
            setTimeout(() => {
                addMessage('Interview completed! Redirecting to dashboard...', 'ai');
                setTimeout(() => {
                    window.location.href = '/dashboard';
                }, 2000);
            }, 1000);
        } else {
            questionNumber++;
            currentQuestion = data.next_question;
            
            setTimeout(() => {
                addMessage(`Question ${questionNumber}/5 (${data.difficulty}): ${data.next_question}`, 'ai');
                updateCounters();
            }, 2000);
        }
        
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

function getCurrentDifficulty() {
    const difficulties = ['easy', 'easy', 'medium', 'medium', 'hard'];
    return difficulties[questionNumber - 1] || 'easy';
}

function updateCounters() {
    document.getElementById('questionCounter').textContent = `Question: ${questionNumber}/5`;
    document.getElementById('scoreCounter').textContent = `Score: ${totalScore}/50`;
}
</script>
{% endblock %}